---
title: "education project"
output: git_hub document 
date: "2023-06-12"
---
```{r}
library(ipumsr)
library(dplyr)
library(lmtest)
library(sandwich)

```
```{r}
setwd("C:/Users/gealy/OneDrive/Documents/git/educationimmigrantswages")
ddi <- read_ipums_ddi("usa_00004.xml")
data <- read_ipums_micro(ddi)
```
```{r}
#get a smaller sample to practice because the regression is going to take longer 
#on full dataset
sample =sample_n(data,200000)%>%filter(AGE>=24)%>%filter(UHRSWORK>29)%>%filter(INCWAGE>0)%>%filter(WKSWORK1>30)
```
```{r}
#combine the states of the US into one value 
sample$bplusone <- ifelse(sample$BPL < 150, 1, sample$BPL)

```
```{r}
#perpare the additional variables 
sample$wages=sample$INCWAGE/(sample$WKSWORK1*sample$UHRSWORK)
sample$potentialexperience =sample$AGE-24
```
```{r}

sample <- sample %>% 
  mutate(EDUCD_recoded = case_when(
    EDUCD %in% c(13, 14) ~ 1,  # Grade 1
    EDUCD == 15 ~ 2,  # Grade 2
    EDUCD == 16 ~ 3,  # Grade 3
    EDUCD == 17 ~ 4,  # Grade 4
    EDUCD %in% c(20, 21, 22) ~ 5,  # Grade 5
    EDUCD %in% c(20, 21, 23) ~ 6,  # Grade 6
    EDUCD %in% c(20, 24, 25) ~ 7,  # Grade 7
    EDUCD %in% c(20, 24, 26) ~ 8,  # Grade 8
    EDUCD == 30 ~ 9,  # Grade 9
    EDUCD == 40 ~ 10,  # Grade 10
    EDUCD == 50 ~ 11,  # Grade 11
    EDUCD %in% c(60, 61) ~ 12,  # Grade 12
    EDUCD %in% c(62, 63, 64) ~ 13,  # High school graduate or GED
    EDUCD == 65 ~ 14,  # Some college, but less than 1 year
    EDUCD %in% c(70, 71, 80, 81, 82, 83) ~ 15,  # 1 or more years of college, no degree
    EDUCD %in% c(90, 100, 110, 113) ~ 16,  # 4 years of college
    EDUCD == 114 ~ 17.5,  # Master's degree
    EDUCD %in% c(115, 116) ~ 21,  # Doctoral degree
    TRUE ~ NA_real_  # Other cases
  ))


```

```{r}

  # Initialize an empty list to store the models and coeftests
models <- list()
coeftests <- list()

# Count the number of records for each country
country_counts <- table(sample$bplusone)

# Get only the countries with more than one record
countries <- as.numeric(names(country_counts[country_counts > 1]))

# Initialize a list to store the country codes
country_codes <- c()

# Loop over each country
for (country in countries) {
  
  # Subset the data for the current country
  country_data <- subset(sample, bplusone == country)
  
  # Check if there are any non-NA rows
  if (sum(complete.cases(country_data)) > 0) {
    
    # Fit the model
    models[[length(models) + 1]] <- lm(log(wages) ~ EDUCD_recoded, data = country_data)
    
    # Perform coeftest with robust standard errors and store the result
    coeftests[[length(coeftests) + 1]] <- coeftest(models[[length(models)]], vcov = vcovHC(models[[length(models)]], type = "HC1"))
    
    # Store the country code
    country_codes <- c(country_codes, country)
  }
}

# Set the names of the models and coeftests lists
names(models) <- country_codes
names(coeftests) <- country_codes

# Create a dataframe with country codes
df <- data.frame(CountryCode = country_codes, stringsAsFactors = FALSE)




```
```{r}
finaldata=data%>%filter(AGE>=24)%>%filter(UHRSWORK>29)%>%filter(INCWAGE>0)%>%filter(WKSWORK1>30)%>%filter(YRIMMIG==0|YRIMMIG<=1990)
```
```{r}
#combine the states of the US into one value 
finaldata$bplusone <- ifelse(finaldata$BPL < 150, 1, finaldata$BPL)
```
```{r}
finaldata$SEX=ifelse(finaldata$SEX==2,0,finaldata$SEX)
```

```{r}
#perpare the additional variables 
finaldata$wages=finaldata$INCWAGE/(finaldata$WKSWORK1*finaldata$UHRSWORK)
finaldata$potentialexperience =finaldata$AGE-24
```
```{r}

finaldata <- finaldata %>% 
  mutate(EDUCD_recoded = case_when(
    EDUCD %in% c(13, 14) ~ 1,  # Grade 1
    EDUCD == 15 ~ 2,  # Grade 2
    EDUCD == 16 ~ 3,  # Grade 3
    EDUCD == 17 ~ 4,  # Grade 4
    EDUCD %in% c(20, 21, 22) ~ 5,  # Grade 5
    EDUCD %in% c(20, 21, 23) ~ 6,  # Grade 6
    EDUCD %in% c(20, 24, 25) ~ 7,  # Grade 7
    EDUCD %in% c(20, 24, 26) ~ 8,  # Grade 8
    EDUCD == 30 ~ 9,  # Grade 9
    EDUCD == 40 ~ 10,  # Grade 10
    EDUCD == 50 ~ 11,  # Grade 11
    EDUCD %in% c(60, 61) ~ 12,  # Grade 12
    EDUCD %in% c(62, 63, 64) ~ 13,  # High school graduate or GED
    EDUCD == 65 ~ 14,  # Some college, but less than 1 year
    EDUCD %in% c(70, 71, 80, 81, 82, 83) ~ 15,  # 1 or more years of college, no degree
    EDUCD %in% c(90, 100, 110, 113) ~ 16,  # 4 years of college
    EDUCD == 114 ~ 17.5,  # Master's degree
    EDUCD %in% c(115, 116) ~ 21,  # Doctoral degree
    TRUE ~ NA_real_  # Other cases
  ))

```
```{r}

# Initialize an empty list to store the models and coeftests
bigmodels <- list()
bigcoeftests <- list()

# Count the number of records for each country
country_counts <- table(finaldata$bplusone)

# Get only the countries with more than one record
countries <- as.numeric(names(country_counts[country_counts > 1]))

# Initialize a list to store the country codes
bigcountry_codes <- c()
# Loop over each country
for (country in countries) {
  
  # Subset the data for the current country
  country_data <- subset(finaldata, bplusone == country)
  
  # Check if there are any non-NA rows
  if (sum(complete.cases(country_data)) > 0) {
    
    # Fit the model
    bigmodels[[length(bigmodels) + 1]] <- lm(log(wages) ~ EDUCD_recoded, data = country_data)
    
    # Perform coeftest with robust standard errors and store the result
    bigcoeftests[[length(bigcoeftests) + 1]] <- coeftest(bigmodels[[length(bigmodels)]], vcov = vcovHC(bigmodels[[length(bigmodels)]], type = "HC1"))
    
    # Store the country code
    bigcountry_codes <- c(bigcountry_codes, country)
  }
}

# Set the names of the models and coeftests lists
names(bigmodels) <- bigcountry_codes
names(bigcoeftests) <- bigcountry_codes

# Create a dataframe with country codes
df <- data.frame(CountryCode = bigcountry_codes, stringsAsFactors = FALSE)



```











